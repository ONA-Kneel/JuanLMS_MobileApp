"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DeviceStats = void 0;
var _videoReactBindings = require("@stream-io/video-react-bindings");
var _react = require("react");
var _videoClient = require("@stream-io/video-client");
var _reactNative = require("react-native");
const {
  StreamVideoReactNative
} = _reactNative.NativeModules;
const eventEmitter = new _reactNative.NativeEventEmitter(StreamVideoReactNative);
/**
 * This is a renderless component to get the device stats like thermal state and power saver mode.
 */
const DeviceStats = () => {
  const {
    useCallCallingState
  } = (0, _videoReactBindings.useCallStateHooks)();
  const callingState = useCallCallingState();
  const call = (0, _videoReactBindings.useCall)();
  (0, _react.useEffect)(() => {
    if (!call || callingState !== _videoClient.CallingState.JOINED) return;
    StreamVideoReactNative.isLowPowerModeEnabled().then(initialPowerMode => {
      (0, _videoClient.setPowerState)(initialPowerMode);
      call.tracer.trace('device.lowPowerMode', initialPowerMode);
    });
    const powerModeSubscription = eventEmitter.addListener('isLowPowerModeEnabled', isLowPowerMode => {
      (0, _videoClient.setPowerState)(isLowPowerMode);
      call.tracer.trace('device.lowPowerMode', isLowPowerMode);
    });
    StreamVideoReactNative.currentThermalState().then(initialState => {
      (0, _videoClient.setThermalState)(initialState);
      call.tracer.trace('device.thermalState', initialState);
    });
    const thermalStateSubscription = eventEmitter.addListener('thermalStateDidChange', thermalState => {
      (0, _videoClient.setThermalState)(thermalState);
      call.tracer.trace('device.thermalStateChanged', thermalState);
    });
    const pollBatteryState = () => {
      StreamVideoReactNative.getBatteryState().then(data => {
        call.tracer.trace('device.batteryState', data);
      });
    };

    // poll every 3 minutes, so we can calculate potential battery drain
    const batteryLevelId = setInterval(() => pollBatteryState(), 3 * 60 * 1000);
    pollBatteryState(); // initial call

    const batteryChargingSubscription = eventEmitter.addListener('chargingStateChanged', data => {
      call.tracer.trace('device.chargingStateChanged', data);
    });

    // on android we need to explicitly start and stop the thermal status updates
    if (_reactNative.Platform.OS === 'android') {
      StreamVideoReactNative.startThermalStatusUpdates();
    }
    return () => {
      powerModeSubscription.remove();
      thermalStateSubscription.remove();
      batteryChargingSubscription.remove();
      clearInterval(batteryLevelId);
      if (_reactNative.Platform.OS === 'android') {
        StreamVideoReactNative.stopThermalStatusUpdates();
      }
    };
  }, [call, callingState]);
  return null;
};
exports.DeviceStats = DeviceStats;
//# sourceMappingURL=DeviceStats.js.map